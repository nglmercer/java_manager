import{w as A,v as J,a as Y}from"./runtime-dom.esm-bundler.8y5z4vCJ.js";import{e as S}from"./Emitter.BIRpGEY5.js";import"./fetchapi.CXYT3pXQ.js";import{n as Z,D as Q}from"./pathUtils.CXuP45Gi.js";import{_ as X}from"./_plugin-vue_export-helper.DlAUqK2U.js";import{d as $,c as f,a as s,e as P,k as V,t as h,n as R,F as ee,r as te,f as m,g as re,o as ae,h as se,i as v,w as oe}from"./runtime-core.esm-bundler.D2uX_WMQ.js";const le=$({__name:"FileUploader",props:{apiEndpoint:{},maxFileSize:{default:2*1024*1024*1024},acceptedFileTypes:{},multiple:{type:Boolean,default:!0}},setup(x,{expose:u}){u();const p=x,t=m(!1),T=m(!1),g=m(""),l=m(""),o=m([]),n=m(""),y=m(),d=m(),W=re(()=>p.multiple!==void 0?p.multiple:!0),k=e=>{e.preventDefault(),e.stopPropagation()},_=()=>t.value=!0,E=()=>t.value=!1,N=e=>{if(k(e),E(),!e.dataTransfer)return;const r=e.dataTransfer.files;U(r)},K=e=>{const r=e.target;r.files&&U(r.files)},U=e=>{C();const r=Array.from(e);for(const a of r){if(a.size===0){l.value="empty",g.value="This file is empty. Try again with a file that's not empty.";return}if(a.size>p.maxFileSize){l.value="too-big",g.value=`Yowza, that's a big file. Try again with a file smaller than ${B(p.maxFileSize)}.`;return}if(p.acceptedFileTypes&&!L(a,p.acceptedFileTypes)){l.value="bad-file",g.value="We don't support that file type. Try zipping it.";return}}const i=r.map(a=>({file:a,editedName:a.name,isEditing:!1}));o.value=[...o.value,...i]},O=e=>{o.value=o.value.filter((r,i)=>i!==e)},j=e=>{o.value=o.value.map((r,i)=>i===e?{...r,isEditing:!0}:r)},D=(e,r)=>{o.value=o.value.map((i,a)=>a===e?{...i,editedName:r,isEditing:!1}:i)},L=(e,r)=>r.split(",").map(a=>a.trim()).some(a=>{if(a.startsWith("."))return e.name.toLowerCase().endsWith(a.toLowerCase());if(a.includes("*")){const[c,F]=a.split("/"),[q,G]=e.type.split("/");return c==="*"||c===q&&(F==="*"||F===G)}else return e.type===a}),C=()=>{l.value="",g.value=""},H=()=>{C(),y.value&&y.value.click()},I=async()=>{if(o.value.length!==0){T.value=!0,C();try{const e=new FormData;o.value.forEach(c=>{const F=c.editedName!==c.file.name?new File([c.file],c.editedName,{type:c.file.type}):c.file;e.append("files",F)}),n.value=Z(window.selectedServer+Q.getPath());const r=n.value.startsWith("/")?n.value.substring(1):n.value;e.append("directory",r||""),console.log("formData prepared for backend",e),console.log("currentPath",n.value);const i=await fetch(p.apiEndpoint,{method:"POST",body:e});if(!i.ok){let c={message:`HTTP error! Status: ${i.status}`};try{c=await i.json()}catch{console.warn("Could not parse error response as JSON.")}throw console.error("Upload failed. Server response:",c),new Error(c.message||`HTTP error! Status: ${i.status}`)}o.value=[],y.value&&(y.value.value="");const a=r||window.selectedServer||"";S.emit("file-explorer:refresh-data",{path:a}),window.dispatchEvent(new CustomEvent("update-files",{detail:{path:a}}))}catch(e){console.error("Upload failed (catch block):",e),l.value="failed-request",g.value=String(e)||"Something went really wrong, and we can't process that file. Try another file."}finally{T.value=!1}}},B=e=>e<1024?`${e} B`:e<1024*1024?`${(e/1024).toFixed(2)} KB`:e<1024*1024*1024?`${(e/(1024*1024)).toFixed(2)} MB`:`${(e/(1024*1024*1024)).toFixed(2)} GB`,M=()=>{S.emit("path-navigator:get-current-path",{})};let w=null,b=null;ae(()=>{if(!d.value)return;["dragenter","dragover","dragleave","drop"].forEach(r=>{d.value?.addEventListener(r,k,!1)}),d.value.addEventListener("dragenter",_,!1),d.value.addEventListener("dragover",_,!1),d.value.addEventListener("dragleave",E,!1),d.value.addEventListener("drop",N,!1),w=S.on("path-navigator:current-path",r=>{n.value=r.path}),b=S.on("path-navigator:path-changed",r=>{n.value=r.path}),M()}),se(()=>{if(!d.value)return;["dragenter","dragover","dragleave","drop"].forEach(r=>{d.value?.removeEventListener(r,k)}),d.value.removeEventListener("dragenter",_),d.value.removeEventListener("dragover",_),d.value.removeEventListener("dragleave",E),d.value.removeEventListener("drop",N),w&&w(),b&&b()});const z={props:p,isDragging:t,isUploading:T,errorMessage:g,errorType:l,files:o,currentPath:n,fileInputRef:y,dropAreaRef:d,multiple:W,preventDefaults:k,highlight:_,unhighlight:E,handleDrop:N,handleFileSelect:K,handleFiles:U,removeFile:O,startEditing:j,saveFileName:D,isFileTypeAccepted:L,resetErrors:C,retryUpload:H,uploadFiles:I,formatFileSize:B,getCurrentPath:M,get unsubscribeCurrentPath(){return w},set unsubscribeCurrentPath(e){w=e},get unsubscribePathChanged(){return b},set unsubscribePathChanged(e){b=e}};return Object.defineProperty(z,"__isScriptSetup",{enumerable:!1,value:!0}),z}}),ne={class:"file-uploader"},ie=["data-error-type"],de=["multiple","accept"],ce={key:0,class:"default"},ue={class:"upload-message"},pe={key:1,class:"loading"},fe={class:"loading-text"},ve={class:"error-info"},he={key:0,class:"file-list"},me={class:"file-list-header"},ge=["disabled"],ye={class:"file-info"},_e=["onUpdate:modelValue","onBlur","onKeypress"],we=["onClick"],be={class:"file-size"},Fe=["onClick"];function Te(x,u,p,t,T,g){return v(),f("div",ne,[s("label",{ref:"dropAreaRef",class:R(["file-attachment-label",{dragging:t.isDragging},{error:t.errorType}]),"data-error-type":t.errorType},[s("input",{ref:"fileInputRef",type:"file",class:"sr-only",onChange:t.handleFileSelect,multiple:t.multiple,accept:p.acceptedFileTypes},null,40,de),!t.isUploading&&!t.errorMessage?(v(),f("div",ce,[u[1]||(u[1]=s("span",{class:"bg-overlay"},null,-1)),s("span",ue,[u[0]||(u[0]=s("svg",{height:"32",viewBox:"0 0 24 24",width:"32",class:"upload-icon"},[s("path",{d:"M4.97 13.22a.75.75 0 0 1 1.06 0L11 18.19V3.75a.75.75 0 0 1 1.5 0v14.44l4.97-4.97a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734l-6.25 6.25a.75.75 0 0 1-1.06 0l-6.25-6.25a.75.75 0 0 1 0-1.06Z"})],-1)),V(" Attach "+h(t.multiple?"files":"a file")+" by dropping "+h(t.multiple?"them":"it")+" here or selecting "+h(t.multiple?"them":"it")+". ",1)])])):P("",!0),t.isUploading?(v(),f("div",pe,[u[2]||(u[2]=s("svg",{width:"16",height:"16",viewBox:"0 0 16 16",class:"loading-icon"},[s("circle",{cx:"8",cy:"8",r:"7",stroke:"currentColor","stroke-opacity":"0.25","stroke-width":"2","vector-effect":"non-scaling-stroke",fill:"none"}),s("path",{d:"M15 8a7.002 7.002 0 00-7-7",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","vector-effect":"non-scaling-stroke"})],-1)),s("span",fe,"Uploading your "+h(t.multiple?"files":"file")+" now…",1)])):P("",!0),t.errorMessage?(v(),f("div",{key:2,class:R(["error",t.errorType])},[V(h(t.errorMessage)+" ",1),s("span",ve,[s("span",{class:"retry-text",onClick:A(t.retryUpload,["stop"])}," Try "+h(t.errorType==="duplicate-filename"?"a different file":"another file")+". ",1)])],2)):P("",!0)],10,ie),t.files.length>0?(v(),f("div",he,[s("div",me,[u[3]||(u[3]=s("h3",null,"Selected Files:",-1)),s("button",{class:"upload-button",onClick:t.uploadFiles,disabled:t.isUploading}," Upload All Files ",8,ge)]),s("ul",null,[(v(!0),f(ee,null,te(t.files,(l,o)=>(v(),f("li",{key:o},[s("div",ye,[l.isEditing?oe((v(),f("input",{key:0,type:"text","onUpdate:modelValue":n=>l.editedName=n,onBlur:n=>t.saveFileName(o,l.editedName),onKeypress:Y(n=>t.saveFileName(o,l.editedName),["enter"])},null,40,_e)),[[J,l.editedName]]):(v(),f("span",{key:1,class:"file-name",onClick:n=>t.startEditing(o),title:"Click to edit filename"},h(l.editedName),9,we)),s("span",be,"("+h(t.formatFileSize(l.file.size))+")",1)]),s("button",{class:"remove-file",onClick:A(n=>t.removeFile(o),["prevent"]),title:"Remove file"}," ✕ ",8,Fe)]))),128))])])):P("",!0)])}const Ue=X(le,[["render",Te]]);export{Ue as default};
